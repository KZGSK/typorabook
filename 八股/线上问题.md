# 线上问题

## JVM调优

**调优时机**：Heap内存（老年代）持续上涨达到设置的最大内存值；Full GC 次数频繁；GC 停顿时间过长（超过1秒）；系统吞吐量与响应性能不高或下降。

**调优目标**：降低延迟、内存占用、提高吞吐量（只能选择两个，不能兼得）

**步骤**

**分析系统运行情况：**分析GC日志以及dump文件，判断是否需要优化，确定瓶颈问题点

找到gc.log，可以看GC发生的时间、原因、以及堆使用的容量、GC后的容量、GC花费时间

可以借助分析软件更直观的分析日志如gceasy可以判断性能指标

java内存dump是jvm运行时内存的一份快照，利用它可以分析是否存在内存浪费，可以检查内存管理是否合理，当发生OOM的时候，可以找出问题的原因。使用**jmap**获得文件。

jstat 命令可以对Heap size和垃圾回收状况的监控。

使用jprofiler分析dump文件，可以看所有类和它们的实例、显示对象的引用等可以判断是否内存泄漏

**优化**：依据问题来优化，如频繁GC就加大内存(或者出现内存泄漏)。停顿时间长可能是垃圾太多耗时，采用并发垃圾回收器CMS等

**例子：**

浏览量暴增，响应变慢。发现是GC频率高时间长，解决增大内存。

不定期间断性卡顿，偶尔变慢：内存大后单次GC时间变长，使用并发类收集器CMS。

线上服务运行时间长变慢：可能是频繁FGC，存在大对象占据老年代，一直不释放。或者内存泄漏。解决可以增大老年代

## CPU占用过高

**调查**

可以使用Top命令，看看哪个进程占用CPU以及使用 top -Hp进程中哪个线程占用高。再使用jstack查询线程的堆栈信息。

**优化**：可能观察耗时线程都在GC，可能内存溢出oom

## OOM

常见的内存溢出：方法区溢出、虚拟机栈溢出(死循环)、堆内存溢出

**分析**：可以分析dump文件或者jmap命令查看内存分布。如果内存小就加大内存，如果对象不释放就优化代码

## MySQL慢查询

**定位**

可以配置慢查询日志slow_query_log ，将大于设定值时间的语句进行记录

**分析**

使用explain对SQL进行的分析，看执行计划：读取顺序、查询类型、用到了什么索引、使用索引的长度 、扫描了多少条记录等